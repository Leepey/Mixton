// scripts/checkAllMethods.ts
import { Address, toNano } from '@ton/core';
import { Mixton } from '../wrappers/Mixton';
import { NetworkProvider } from '@ton/blueprint';

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã
const formatDate = (timestamp: number): string => {
    if (timestamp === -1) return 'N/A';
    return new Date(timestamp * 1000).toLocaleString();
};

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–¥—Ä–µ—Å–∞
const formatAddress = (address: Address | null | undefined): string => {
    if (!address) return 'N/A';
    return address.toString();
};

export async function run(provider: NetworkProvider) {
    const ui = provider.ui();

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–¥—Ä–µ—Å –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –∏–∑ .env –∏–ª–∏ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –µ—Å–ª–∏ –æ–Ω –∑–∞–¥–∞–Ω
    let contractAddress: Address;
    const contractAddressFromEnv = process.env.CONTRACT_ADDRESS;

    if (contractAddressFromEnv) {
        contractAddress = Address.parse(contractAddressFromEnv);
        ui.write(`Using contract address from .env: ${contractAddress.toString()}\n`);
    } else {
        // –ï—Å–ª–∏ –∞–¥—Ä–µ—Å –Ω–µ –∑–∞–¥–∞–Ω, –ø–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –µ–≥–æ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–µ–ø–ª–æ—è (—ç—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–∏, –∫–æ—Ç–æ—Ä—É—é –º—ã –∑–¥–µ—Å—å –Ω–µ —Ä–µ–∞–ª–∏–∑—É–µ–º)
        // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –ø–æ—Ç—Ä–µ–±—É–µ–º, —á—Ç–æ–±—ã –∞–¥—Ä–µ—Å –±—ã–ª –≤ .env
        throw new Error('Contract address not found. Please deploy the contract first or set CONTRACT_ADDRESS in your .env file.');
    }

    const mixton = provider.open(Mixton.createFromAddress(contractAddress));
    ui.write(`üîç Checking all methods for contract: ${mixton.address.toString()}\n`);

    // --- Get-–º–µ—Ç–æ–¥—ã ---
    ui.write('üìä Testing GET methods:\n');

    try {
        const admin = await mixton.getAdmin();
        ui.write(`‚úÖ getAdmin(): ${formatAddress(admin)}\n`);
    } catch (e) {
        ui.write(`‚ùå getAdmin(): Error - ${e instanceof Error ? e.message : String(e)}\n`);
    }

    try {
        const params = await mixton.getMixerParams();
        ui.write(`‚úÖ getMixerParams(): MinFee=${params.minFeeRate/100}%, MaxFee=${params.maxFeeRate/100}%, MinDelay=${params.minDelay}s, MaxDelay=${params.maxDelay}s\n`);
    } catch (e) {
        ui.write(`‚ùå getMixerParams(): Error - ${e instanceof Error ? e.message : String(e)}\n`);
    }

    try {
        const currentFeeRate = await mixton.getCurrentFeeRate();
        ui.write(`‚úÖ getCurrentFeeRate(): ${currentFeeRate/100}%\n`);
    } catch (e) {
        ui.write(`‚ùå getCurrentFeeRate(): Error - ${e instanceof Error ? e.message : String(e)}\n`);
    }

    try {
        const limits = await mixton.getLimits();
        ui.write(`‚úÖ getLimits(): MinDep=${Mixton.formatAmount(limits.minDeposit)} TON, MaxDep=${Mixton.formatAmount(limits.maxDeposit)} TON, MinWith=${Mixton.formatAmount(limits.minWithdraw)} TON\n`);
    } catch (e) {
        ui.write(`‚ùå getLimits(): Error - ${e instanceof Error ? e.message : String(e)}\n`);
    }

    try {
        const stats = await mixton.getBasicStats();
        ui.write(`‚úÖ getBasicStats(): TotalDeposits=${stats.totalDeposits}, TotalWithdrawn=${Mixton.formatAmount(stats.totalWithdrawn)} TON\n`);
    } catch (e) {
        ui.write(`‚ùå getBasicStats(): Error - ${e instanceof Error ? e.message : String(e)}\n`);
    }

    try {
        const lastDepositId = await mixton.getLastDepositId();
        ui.write(`‚úÖ getLastDepositId(): ${lastDepositId.toString()}\n`);
    } catch (e) {
        ui.write(`‚ùå getLastDepositId(): Error - ${e instanceof Error ? e.message : String(e)}\n`);
    }
    
    try {
        const queueInfo = await mixton.getQueueInfo();
        ui.write(`‚úÖ getQueueInfo(): Length=${queueInfo.queueLength}, Amount=${Mixton.formatAmount(queueInfo.totalAmount)} TON\n`);
    } catch (e) {
        ui.write(`‚ùå getQueueInfo(): Error - ${e instanceof Error ? e.message : String(e)}\n`);
    }

    try {
        const queueStatusNumber = await mixton.getQueueStatus();
        let statusText = 'Unknown';
        if (queueStatusNumber === 0) statusText = 'Empty';
        else if (queueStatusNumber === 1) statusText = 'Waiting';
        else if (queueStatusNumber === 2) statusText = 'Ready';
        ui.write(`‚úÖ getQueueStatus(): ${statusText} (${queueStatusNumber})\n`);
    } catch (e) {
        ui.write(`‚ùå getQueueStatus(): Error - ${e instanceof Error ? e.message : String(e)}\n`);
    }

    try {
        const minNextTime = await mixton.getMinNextTime();
        ui.write(`‚úÖ getMinNextTime(): ${minNextTime}s (${formatDate(minNextTime)})\n`);
    } catch (e) {
        ui.write(`‚ùå getMinNextTime(): Error - ${e instanceof Error ? e.message : String(e)}\n`);
    }
    
    try {
        const queueDetails = await mixton.getQueueDetails();
        ui.write(`‚úÖ getQueueDetails(): Length=${queueDetails.queueLength}, Amount=${Mixton.formatAmount(queueDetails.totalAmount)} TON, NextTime=${queueDetails.nextTime}s (${formatDate(queueDetails.nextTime)})\n`);
    } catch (e) {
        ui.write(`‚ùå getQueueDetails(): Error - ${e instanceof Error ? e.message : String(e)}\n`);
    }

    try {
        const signersInfo = await mixton.getSigners();
        ui.write(`‚úÖ getSigners(): Count=${signersInfo.count}, Required=${signersInfo.required}\n`);
    } catch (e) {
        ui.write(`‚ùå getSigners(): Error - ${e instanceof Error ? e.message : String(e)}\n`);
    }

    try {
        const oracleData = await mixton.getOracleData();
        ui.write(`‚úÖ getOracleData(): Data=${oracleData.data}, LastUpdate=${formatDate(oracleData.lastUpdate)}\n`);
    } catch (e) {
        ui.write(`‚ùå getOracleData(): Error - ${e instanceof Error ? e.message : String(e)}\n`);
    }

    try {
        const history = await mixton.getTransactionHistory();
        ui.write(`‚úÖ getTransactionHistory(): Found ${history.length} records.\n`);
        // –ú–æ–∂–Ω–æ –≤—ã–≤–µ—Å—Ç–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–ø–∏—Å–µ–π –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞
        history.slice(-3).forEach((record, index) => {
            const typeText = record.txType === 0 ? 'Deposit' : record.txType === 1 ? 'Withdrawal' : 'Fee';
            ui.write(`   Record ${history.length - history.slice(-3).length + index + 1}: Type=${typeText}, To/From=${formatAddress(record.address)}, Amount=${Mixton.formatAmount(record.amount)} TON, Status=${record.status === 0 ? 'Pending' : record.status === 1 ? 'Completed' : 'Error'}, Time=${formatDate(record.timestamp)}\n`);
        });
    } catch (e) {
        ui.write(`‚ùå getTransactionHistory(): Error - ${e instanceof Error ? e.message : String(e)}\n`);
    }
    
    // --- Get-–º–µ—Ç–æ–¥—ã —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ ---
    ui.write('\nüìä Testing GET methods with parameters:\n');

    try {
        const depositInfo = await mixton.getDepositInfo(BigInt(1)); // –ü—Ä–æ–≤–µ—Ä–∏–º –ø–µ—Ä–≤—ã–π –¥–µ–ø–æ–∑–∏—Ç
        if (depositInfo) {
            ui.write(`‚úÖ getDepositInfo(1): Time=${formatDate(depositInfo.depositTime)}, Delay=${depositInfo.delay}s, Status=${depositInfo.status === 0 ? 'Pending' : 'Processed'}\n`);
        } else {
            ui.write(`‚úÖ getDepositInfo(1): Deposit not found or null returned.\n`);
        }
    } catch (e) {
        ui.write(`‚ùå getDepositInfo(1): Error - ${e instanceof Error ? e.message : String(e)}\n`);
    }

    try {
        const isBlacklisted = await mixton.isAddressBlacklisted(Address.parse('EQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAM9c')); // –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∞–¥—Ä–µ—Å
        ui.write(`‚úÖ isAddressBlacklisted(EQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAM9c): ${isBlacklisted}\n`);
    } catch (e) {
        ui.write(`‚ùå isAddressBlacklisted(...): Error - ${e instanceof Error ? e.message : String(e)}\n`);
    }
    
    try {
        const isAdmin = await mixton.isAdmin(provider.sender().address!);
        ui.write(`‚úÖ isAdmin(${provider.sender().address?.toString()}): ${isAdmin}\n`);
    } catch (e) {
        ui.write(`‚ùå isAdmin(...): Error - ${e instanceof Error ? e.message : String(e)}\n`);
    }

    // --- –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —É—Ç–∏–ª–∏—Ç–∞—Ä–Ω—ã–µ –º–µ—Ç–æ–¥—ã ---
    ui.write('\nüîß Testing static utility methods:\n');

    ui.write(`‚úÖ formatDelay(3600): ${Mixton.formatDelay(3600)}\n`);
    ui.write(`‚úÖ formatDelay(1800): ${Mixton.formatDelay(1800)}\n`);
    ui.write(`‚úÖ formatFeeRate(250): ${Mixton.formatFeeRate(250)}\n`);
    ui.write(`‚úÖ formatAmount(toNano('1.5')): ${Mixton.formatAmount(toNano('1.5'))} TON\n`);
    
    const testAmount = toNano('10');
    const testFeeRate = 200; // 2%
    const fee = mixton.calculateFee(testAmount, testFeeRate);
    const netAmount = mixton.calculateNetAmount(testAmount, testFeeRate);
    ui.write(`‚úÖ calculateFee(${Mixton.formatAmount(testAmount)} TON, ${testFeeRate}): ${Mixton.formatAmount(fee)} TON\n`);
    ui.write(`‚úÖ calculateNetAmount(${Mixton.formatAmount(testAmount)} TON, ${testFeeRate}): ${Mixton.formatAmount(netAmount)} TON\n`);

    // --- Health Check ---
    ui.write('\nüè• Running health check...\n');
    try {
        const health = await mixton.healthCheck(provider.provider(mixton.address));
        ui.write(`Health Status: ${health.healthy ? '‚úÖ HEALTHY' : '‚ùå UNHEALTHY'}\n`);
        if (health.issues.length > 0) {
            health.issues.forEach(issue => ui.write(` - Issue: ${issue}\n`));
        }
    } catch (e) {
        ui.write(`‚ùå healthCheck(): Error - ${e instanceof Error ? e.message : String(e)}\n`);
    }

    // --- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ send-–º–µ—Ç–æ–¥–∞—Ö (–±–µ–∑ –≤—ã–∑–æ–≤–∞) ---
    ui.write('\nüì§ Information about SEND methods (not called in this script):\n');
    ui.write('‚úÖ sendDeposit(sender, value)\n');
    ui.write('‚úÖ sendWithdraw(sender, recipient, amount, depositId, feeRate, delay, value)\n');
    ui.write('‚úÖ sendMultiWithdraw(sender, request, value)\n');
    ui.write('‚úÖ sendEmergencyWithdraw(sender, amount, value)\n');
    ui.write('‚úÖ sendAddToBlacklist(sender, address, value)\n');
    ui.write('‚úÖ sendRemoveFromBlacklist(sender, address, value)\n');
    ui.write('‚úÖ sendProcessQueue(sender, value)\n');
    ui.write('‚úÖ sendSetFeeRate(sender, feeRate, value)\n');
    ui.write('‚úÖ sendAddSigner(sender, signer, value)\n');
    ui.write('‚úÖ sendRemoveSigner(sender, signer, value)\n');
    ui.write('‚úÖ sendUpdateOracle(sender, oracleData, value)\n');
    
    ui.write('\nüéâ All available methods checked.\n');
}